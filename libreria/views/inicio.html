<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Monitoreo</title>
  <!-- Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

  <div class="container py-4">
    <h1 class="mb-4 text-center">游댢 Tablero de Monitoreo</h1>

    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        Informaci칩n del Servicio
      </div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Nombre del Servicio:</strong> {{ sistema.nombre }}</li>
          <li class="list-group-item"><strong>Direcci칩n:</strong> {{ sistema.ubicacion }}</li>
          <li class="list-group-item"><strong>Descripci칩n:</strong> {{ sistema.descripcion }}</li>
          <li class="list-group-item"><strong>Latitud:</strong> {{ sistema.latitud }}</li>
          <li class="list-group-item"><strong>Longitud:</strong> {{ sistema.longitud }}</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <div class="card-header bg-success text-white text-center">
        Datos en Tiempo Real
      </div>
      <div class="card-body p-0">
        <table class="table table-bordered table-hover text-center mb-0">
          <thead class="table-light">
            <tr>
              <th>Fase</th>
              <th>Voltaje (V)</th>
              <th>Corriente (A)</th>
              <th>Factor de Potencia</th>
              <th>Potencia (kW)</th>
              <th>Marcad de Tiempo</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>A</td>
              <td><span id="voltage a">--</span></td>
              <td><span id="current a">--</span></td>
              <td><span id="angle a">--</span></td>
              <td><span id="power a">--</span></td>
              <td><span id="last_lec a">--</span></td>
            </tr>
            <tr>
              <td>B</td>
              <td><span id="voltage b">--</span></td>
              <td><span id="current b">--</span></td>
              <td><span id="angle b">--</span></td>
              <td><span id="power b">--</span></td>
              <td><span id="last_lec b">--</span></td>
            </tr>
            <tr>
              <td>C</td>
              <td><span id="voltage c">--</span></td>
              <td><span id="current c">--</span></td>
              <td><span id="angle c">--</span></td>
              <td><span id="power c">--</span></td>
              <td><span id="last_lec c">--</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div id="container" class="my-5"></div>

    <div id="grafica-a"></div>
    <div id="grafica-b"></div>
    <div id="grafica-c"></div>

    <footer class="mt-5 text-center text-muted">
      <small>Monitoreo de par치metros el칠ctricos en transformadores </small>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/modules/data.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/export-data.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>
  <!-- <script src="https://code.highcharts.com/themes/adaptive.js"></script> -->


  <script>
    function fetchLiveData1() {
      fetch('/api/get_lecturas/?sistema={{ sistema.nombre }}')
        .then(response => response.json())
        .then(data => {
          datos = data.datos
          if (datos['A']) {
            document.getElementById('voltage a').textContent = datos['A'].voltaje;
            document.getElementById('current a').textContent = datos['A'].corriente;
            document.getElementById('angle a').textContent = datos['A'].angulo;
            document.getElementById('power a').textContent = datos['A'].kwh;
            document.getElementById('last_lec a').textContent = datos['A'].tiempo;
          }
          if (datos['B']) {
            document.getElementById('voltage b').textContent = datos['B'].voltaje;
            document.getElementById('current b').textContent = datos['B'].corriente;
            document.getElementById('angle b').textContent = datos['B'].angulo;
            document.getElementById('power b').textContent = datos['B'].kwh;
            document.getElementById('last_lec b').textContent = datos['B'].tiempo;
          }
          if (datos['C']) {
            document.getElementById('voltage c').textContent = datos['C'].voltaje;
            document.getElementById('current c').textContent = datos['C'].corriente;
            document.getElementById('angle c').textContent = datos['C'].angulo;
            document.getElementById('power c').textContent = datos['C'].kwh;
            document.getElementById('last_lec c').textContent = datos['C'].tiempo;

          }
        })
        .catch(error => console.error('Fetch error:', error));

    }

    setInterval(fetchLiveData1, 10000);
    fetchLiveData1();



    // function createChart() {
    //   Highcharts.chart('container', {

    //     title: {
    //       text: 'Fase A',
    //       align: 'center'
    //     },
    //     legend: {
    //       layout: 'vertical',
    //       align: 'right',
    //       verticalAlign: 'middle'
    //     },

    //     series: [{
    //       name: 'VA',
    //       data: VA
    //     },
    //     {
    //       name: 'IA',
    //       data: VA
    //     },
    //     {
    //       name: 'FP',
    //       data: VA
    //     },
    //     {
    //       name: 'kW',
    //       data: VA
    //     }],

    //     responsive: {
    //       rules: [{
    //         condition: {
    //           maxWidth: 500
    //         },
    //         chartOptions: {
    //           legend: {
    //             layout: 'horizontal',
    //             align: 'center',
    //             verticalAlign: 'bottom'
    //           }
    //         }
    //       }]
    //     }

    //   });


    // }

    // // urlInput = defaultData;

    // // We recreate instead of using chart update to make sure the loaded CSV
    // // and such is completely gone.
    // // pollingCheckbox.onchange = urlInput.onchange =
    // // pollingInput.onchange = createChart;

    // // Create the chart
    // createChart();

    let chartA, chartB, chartC;

    function calcularKW(v, i, angulo) {
      return (v * i * Math.cos(angulo * Math.PI / 180)) / 1000;
    }

    function procesarDatos(datosFase) {
      const tiempos = [];
      const voltajes = [];
      const corrientes = [];
      const angulos = [];
      const kw = [];

      for (const item of datosFase.reverse()) {
        const t = new Date(item.tiempo).toLocaleString();
        tiempos.push(t);
        voltajes.push(item.voltaje);
        corrientes.push(item.corriente);
        angulos.push(item.angulo);
        kw.push(item.kwh);
        // kw.push(calcularKW(item.voltaje, item.corriente, item.angulo));
      }

      return { tiempos, voltajes, corrientes, angulos, kw };
    }

    function actualizarGrafica(chart, datos, fase) {
      chart.update({
        chart: {
          zooming: {
            type: 'x'
          }
        },
        title: { text: `Fase ${fase}` },
        xAxis: { categories: datos.tiempos, type: 'datetime' },
        yAxis: [
          {
            labels: {
              format: '{value} V',
              // style: { color: '#1f77b4' }
            },
            opposite: true,
          },
          {
            labels: {
              format: '{value} A',
              // style: { color: '#ff7f0e' }
            },
            opposite: true,
          },
          {
            labels: {
              format: '{value} 춿',
              // style: { color: '#2ca02c' }
            },
            opposite: true,
          },
          {
            labels: {
              format: '{value} kW',
              // style: { color: ' #d62728' }
            },
            opposite: true,
          }

        ],
        series: [
          { name: 'Voltaje (V)', data: datos.voltajes,
           yAxis: 0
          },
          { name: 'Corriente (A)', data: datos.corrientes,
          // yAxis: 1
        },
          { name: '츼ngulo (춿)', data: datos.angulos,
          // yAxis: 2
        },
          { name: 'Potencia (kW)', data: datos.kw,
          // yAxis: 3
        }
        ]
      });
    }

    function crearGrafica(contenedor, titulo) {
      return Highcharts.chart(contenedor, {
        chart: { type: 'spline' },
        title: { text: titulo },
        xAxis: { categories: [] },
        yAxis: { title: { text: 'Valor' } },
        series: [
          { name: 'Voltaje (V)', data: [] },
          { name: 'Corriente (A)', data: [] },
          { name: '츼ngulo (춿)', data: [] },
          { name: 'Potencia (kW)', data: [] }
        ]
      });
    }

    function fetchLiveData() {
      fetch('/api/get_lecturas_historia/?sistema={{ sistema.nombre }}')
        .then(response => response.json())
        .then(data => {
          const datos = data.datos;

          if (datos['A']) {
            const datosA = procesarDatos(datos['A']);
            actualizarGrafica(chartA, datosA, 'A');
          }
          if (datos['B']) {
            const datosB = procesarDatos(datos['B']);
            actualizarGrafica(chartB, datosB, 'B');
          }
          if (datos['C']) {
            const datosC = procesarDatos(datos['C']);
            actualizarGrafica(chartC, datosC, 'C');
          }
        })
        .catch(error => console.error('Fetch error:', error));
    }

    // Inicializar las gr치ficas vac칤as
    chartA = crearGrafica('grafica-a', 'Fase A');
    chartB = crearGrafica('grafica-b', 'Fase B');
    chartC = crearGrafica('grafica-c', 'Fase C');

    // Llamadas peri칩dicas
    fetchLiveData();
    setInterval(fetchLiveData, 10000);
  </script>
</body>

</html>
